import android.content.Context
import androidx.health.connect.client.HealthConnectClient
import androidx.health.connect.client.permission.HealthPermission
import androidx.health.connect.client.records.*
import androidx.health.connect.client.request.ReadRecordsRequest
import androidx.health.connect.client.time.TimeRangeFilter
import java.time.Instant
import java.time.ZonedDateTime

/**
 * Gestionnaire pour Health Connect
 * Gère les permissions et la récupération de TOUTES les données de santé
 */
class HealthConnectManager(private val context: Context) {

    private val healthConnectClient by lazy { HealthConnectClient.getOrCreate(context) }

    /**
     * Liste exhaustive des permissions pour "absolument toutes" les données courantes.
     * Note : Vous devez déclarer ces permissions dans votre AndroidManifest.xml également.
     */
    val allPermissions = setOf(
        // Activité
        HealthPermission.getReadPermission(StepsRecord::class),
        HealthPermission.getReadPermission(DistanceRecord::class),
        HealthPermission.getReadPermission(TotalCaloriesBurnedRecord::class),
        HealthPermission.getReadPermission(ActiveCaloriesBurnedRecord::class),
        HealthPermission.getReadPermission(ExerciseSessionRecord::class),
        // Signes vitaux
        HealthPermission.getReadPermission(HeartRateRecord::class),
        HealthPermission.getReadPermission(RestingHeartRateRecord::class),
        HealthPermission.getReadPermission(OxygenSaturationRecord::class),
        HealthPermission.getReadPermission(BloodPressureRecord::class),
        HealthPermission.getReadPermission(BodyTemperatureRecord::class),
        // Sommeil et Nutrition
        HealthPermission.getReadPermission(SleepSessionRecord::class),
        HealthPermission.getReadPermission(HydrationRecord::class),
        HealthPermission.getReadPermission(NutritionRecord::class),
        // Mensurations
        HealthPermission.getReadPermission(WeightRecord::class),
        HealthPermission.getReadPermission(BodyFatRecord::class),
        HealthPermission.getReadPermission(HeightRecord::class)
    )

    /**
     * Vérifie si Health Connect est disponible sur l'appareil
     */
    fun checkAvailability(): Int {
        return HealthConnectClient.getSdkStatus(context)
    }

    /**
     * Vérifie si toutes les permissions sont accordées
     */
    suspend fun hasAllPermissions(): Boolean {
        val granted = healthConnectClient.permissionController.getGrantedPermissions()
        return granted.containsAll(allPermissions)
    }

    /**
     * Récupère le nombre de pas sur une période donnée
     */
    suspend fun readSteps(startTime: Instant, endTime: Instant): List<StepsRecord> {
        return try {
            val response = healthConnectClient.readRecords(
                ReadRecordsRequest(
                    recordType = StepsRecord::class,
                    timeRangeFilter = TimeRangeFilter.between(startTime, endTime)
                )
            )
            response.records
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * Récupère les données de fréquence cardiaque
     */
    suspend fun readHeartRate(startTime: Instant, endTime: Instant): List<HeartRateRecord> {
        return try {
            val response = healthConnectClient.readRecords(
                ReadRecordsRequest(
                    recordType = HeartRateRecord::class,
                    timeRangeFilter = TimeRangeFilter.between(startTime, endTime)
                )
            )
            response.records
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * Récupère les sessions de sommeil
     */
    suspend fun readSleepSessions(startTime: Instant, endTime: Instant): List<SleepSessionRecord> {
        return try {
            val response = healthConnectClient.readRecords(
                ReadRecordsRequest(
                    recordType = SleepSessionRecord::class,
                    timeRangeFilter = TimeRangeFilter.between(startTime, endTime)
                )
            )
            response.records
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * Exemple de lecture générique pour n'importe quel type de donnée
     */
    suspend fun <T : Record> readData(
        recordType: kotlin.reflect.KClass<T>,
        startTime: Instant,
        endTime: Instant
    ): List<T> {
        return try {
            val response = healthConnectClient.readRecords(
                ReadRecordsRequest(
                    recordType = recordType,
                    timeRangeFilter = TimeRangeFilter.between(startTime, endTime)
                )
            )
            response.records
        } catch (e: Exception) {
            emptyList()
        }
    }
}

/**
 * Exemple d'implémentation dans un Fragment ou une Activity
 */
/*
class HealthActivity : AppCompatActivity() {
    private lateinit var manager: HealthConnectManager

    // Le contrat pour demander les permissions
    private val requestPermissions = registerForActivityResult(
        PermissionController.createRequestPermissionResultContract()
    ) { granted ->
        if (granted.containsAll(manager.allPermissions)) {
            // Toutes les permissions sont ok
            fetchData()
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        manager = HealthConnectManager(this)

        lifecycleScope.launch {
            if (!manager.hasAllPermissions()) {
                requestPermissions.launch(manager.allPermissions)
            } else {
                fetchData()
            }
        }
    }

    private fun fetchData() {
        lifecycleScope.launch {
            val start = ZonedDateTime.now().minusDays(1).toInstant()
            val end = Instant.now()
            
            val steps = manager.readSteps(start, end)
            val heartRate = manager.readHeartRate(start, end)
            
            // Traitement des données...
        }
    }
}
*/